Процедура відкату (rollback) у разі невдалого оновлення
У разі невдалого оновлення важливо мати чіткий процес відкату для повернення до стабільної версії програми. Нижче наведена покрокова процедура відкату:

1. Підготовка до відкату
   1.1. Перевірити останній стан резервних копій:
   • Переконатися, що резервні копії коду, бази даних і конфігурацій збережені в безпечному місці (відповідно до кроків резервного копіювання, описаних раніше).
   1.2. Перевірити час останнього бекапу:
   • Якщо резервні копії були зроблені недавно, перевірити, чи всі дані актуальні та можна відкатити на необхідний стан.

2. Визначення проблеми
   2.1. Оцінити помилки:
   • Переглянути логи серверів (наприклад, tail -f /var/log/nginx/error.log та tail -f /var/log/php-fpm.log).
   • Перевірити логи Laravel за допомогою:
   tail -f storage/logs/laravel.log
   2.2. Ідентифікувати, чи проблема пов'язана з кодом, міграцією, конфігурацією чи іншим компонентом.

3. Відкат коду
   3.1. Якщо код виявився причиною проблеми:
   • Перевести репозиторій на попередню стабільну версію за допомогою git:
   git checkout <previous-stable-commit>
   git reset --hard <previous-stable-commit>
   git pull origin <stable-branch>
   • Якщо використовуєте деплой через CI/CD, автоматичний відкат зазвичай вже налаштований на стабільну версію.
   3.2. Встановити попередню версію залежностей:
   • Якщо після оновлення пакети не відповідають, відкатити їх до стабільної версії:
   composer install --no-dev --optimize-autoloader

4. Відкат бази даних
   4.1. Якщо міграції бази даних спричинили проблему, виконати відкат:
   • Laravel має команду для відкату останніх міграцій:
   php artisan migrate:rollback --step=1
   • Якщо потрібно відкотити всі міграції:
   php artisan migrate:reset
   4.2. Відновлення бази даних з резервної копії:
   • Відновити БД з бекапу:
   mysql -u USERNAME -p DB_NAME < ~/backups/db_backup_YYYY-MM-DD.sql
   • Якщо використовуєте іншу СУБД (наприклад, PostgreSQL), скористатися відповідною командою для відновлення.

5. Відкат конфігурацій
   5.1. Відновлення старих конфігураційних файлів:
   • Якщо зміни до .env чи інших конфігурацій спричинили проблеми:
   ◦ Відновити файл .env із резервної копії:
   cp ~/backups/.env.backup.YYYY-MM-DD .env
   5.2. Очистити кеш та знову створити його для старої конфігурації:
   php artisan config:clear
   php artisan config:cache
   php artisan route:cache
   php artisan view:cache

6. Перезапуск служб
   6.1. Перезапустити всі служби, щоб застосувати старі конфігурації та код:
   sudo systemctl restart php-fpm
   sudo systemctl restart nginx

7. Тестування після відкату
   7.1. Перевірити правильність роботи програми:
   • Переконатися, що додаток працює стабільно після відкату.
   • Тестувати ключові функціональності:
   ◦ Перевірити форму для відправки угод
   ◦ Перевірити генерацію PDF
   ◦ Перевірити інтеграцію з Zoho CRM
   7.2. Моніторинг логів та продуктивності:
   • Перевірити логи на наявність нових помилок після відкату.
   • Оцінити навантаження на сервер і реакцію програми.

8. Повідомлення команди
   8.1. Повідомити команду про успішний відкат:
   • Відправити повідомлення команді про те, що відкат успішно виконано і система працює стабільно.
   • Якщо є серйозні проблеми, залучити команду для аналізу та пошуку виправлення.

9. Подальші дії
   9.1. Планувати наступне оновлення:
   • Після виправлення помилок можна повторно планувати оновлення.
   • Можливо, доцільно попередньо провести тестування оновлення на staging-середовищі перед повторним застосуванням на продакшн.
